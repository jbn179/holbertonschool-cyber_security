##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Auxiliary
  include Msf::Auxiliary::Scanner
  include Msf::Auxiliary::Report

  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'Custom TCP Port Scanner',
      'Description'    => %q{
        This module scans a range of ports on a target system
        and identifies which ones are open.
      },
      'Author'         => ['Holberton Student'],
      'License'        => MSF_LICENSE
    ))

    register_options([
      OptInt.new('STARTPORT', [true, 'The starting port number', 1]),
      OptInt.new('ENDPORT', [true, 'The ending port number', 1000]),
      OptInt.new('TIMEOUT', [true, 'The socket connect timeout in seconds', 1])
    ])
  end

  def run_host(ip)
    start_port = datastore['STARTPORT']
    end_port = datastore['ENDPORT']
    timeout = datastore['TIMEOUT']
    open_ports = []

    (start_port..end_port).each do |port|
      begin
        sock = Rex::Socket::Tcp.create(
          'PeerHost' => ip,
          'PeerPort' => port,
          'Timeout'  => timeout
        )
        if sock
          print_good("#{ip}:#{port} - Port #{port} is open on #{ip}")
          open_ports << port
          sock.close
        end
      rescue Rex::ConnectionRefused
        # Port is closed
      rescue Rex::ConnectionTimeout
        # Connection timed out
      rescue ::Errno::ETIMEDOUT
        # Connection timed out
      rescue ::Rex::ConnectionError
        # Connection error
      end
    end

    if open_ports.any?
      print_status("#{ip}:#{open_ports.first} - Open ports on #{ip}: #{open_ports.join(', ')}")
      report_host(host: ip)
      open_ports.each do |port|
        report_service(host: ip, port: port, proto: 'tcp', state: 'open')
      end
    else
      print_status("#{ip} - No open ports found in range #{start_port}-#{end_port}")
    end
  end
end
