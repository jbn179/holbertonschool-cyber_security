##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Auxiliary
  include Msf::Exploit::Remote::SMB::Client
  include Msf::Auxiliary::Scanner
  include Msf::Auxiliary::Report

  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'MS17-010 SMB Vulnerability Checker',
      'Description'    => %q{
        This module checks if a target system is vulnerable to
        MS17-010 (EternalBlue) SMB vulnerability.
      },
      'Author'         => ['Holberton Student'],
      'License'        => MSF_LICENSE,
      'References'     => [
        ['CVE', '2017-0143'],
        ['CVE', '2017-0144'],
        ['CVE', '2017-0145'],
        ['CVE', '2017-0146'],
        ['CVE', '2017-0147'],
        ['CVE', '2017-0148'],
        ['MSB', 'MS17-010'],
        ['URL', 'https://docs.microsoft.com/en-us/security-updates/securitybulletins/2017/ms17-010']
      ]
    ))

    register_options([
      OptInt.new('TIMEOUT', [true, 'Connection timeout in seconds', 10])
    ])
  end

  def run_host(ip)
    print_status("Checking #{ip} for MS17-010 vulnerability")

    begin
      connect
      negotiate_protocol
      session_setup_ntlmv1

      tree_id = tree_connect("\\\\#{ip}\\IPC$")

      if check_ms17_010_vulnerable
        print_good("#{ip} is vulnerable to MS17-010.")
        report_vuln(
          host: ip,
          name: 'MS17-010 SMB Remote Code Execution Vulnerability',
          refs: references,
          info: 'Target is vulnerable to MS17-010 (EternalBlue)'
        )
      else
        print_status("#{ip} is not vulnerable to MS17-010.")
      end

      disconnect
    rescue Rex::ConnectionRefused
      print_error("#{ip} - Connection refused (port 445 closed)")
    rescue Rex::ConnectionTimeout
      print_error("#{ip} - Connection timeout")
    rescue Rex::Proto::SMB::Exceptions::LoginError
      print_error("#{ip} - SMB login error")
    rescue ::Errno::ECONNRESET
      print_error("#{ip} - Connection reset")
    rescue Rex::Proto::SMB::Exceptions::ErrorCode => e
      if e.message.include?('STATUS_ACCESS_DENIED')
        print_status("#{ip} may be patched (access denied)")
      else
        print_error("#{ip} - SMB error: #{e.message}")
      end
    rescue ::Exception => e
      print_error("#{ip} - Error: #{e.class} - #{e.message}")
    end
  end

  def check_ms17_010_vulnerable
    pkt = make_trans2_packet

    begin
      sock.put(pkt)
      response = sock.get_once(1024, datastore['TIMEOUT'])

      if response.nil?
        return false
      end

      if response.length > 8
        nt_status = response[9, 4].unpack('V').first rescue 0

        case nt_status
        when 0xC0000205
          return true
        when 0xC0000008
          return true
        when 0x00000000
          return true
        end
      end
    rescue ::Exception
      return false
    end

    false
  end

  def make_trans2_packet
    setup_count = 1
    setup = "\x0f\x00"

    param = ''
    data = ''

    pkt = Rex::Proto::SMB::Constants::SMB_TRANS2_PKT.make_struct
    simple.client.smb_defaults(pkt['Payload']['SMB'])

    pkt['Payload']['SMB'].v['Command'] = Rex::Proto::SMB::Constants::SMB_COM_TRANSACTION2
    pkt['Payload']['SMB'].v['Flags1'] = 0x18
    pkt['Payload']['SMB'].v['Flags2'] = 0xc807
    pkt['Payload']['SMB'].v['WordCount'] = 15

    pkt['Payload'].v['ParamCountTotal'] = param.length
    pkt['Payload'].v['DataCountTotal'] = data.length
    pkt['Payload'].v['ParamCountMax'] = 10
    pkt['Payload'].v['DataCountMax'] = 65535
    pkt['Payload'].v['SetupCountMax'] = 1
    pkt['Payload'].v['SetupCount'] = setup_count
    pkt['Payload'].v['ParamCount'] = param.length
    pkt['Payload'].v['DataCount'] = data.length
    pkt['Payload'].v['Timeout'] = 0xFFFFFFFF

    pkt['Payload'].v['SetupData'] = setup
    pkt['Payload'].v['Payload'] = param + data

    pkt.to_s
  end
end
